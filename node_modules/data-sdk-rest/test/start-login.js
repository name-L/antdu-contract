/**
 * Created by wuyaoqian on 13-11-24. <br />
 *
 */



var skdClient = require("../index");
var oauthConfig = require("config").oauth;
var userConfig = require("config").user;
var AccessToken = require("../lib/token/access-token");

// 临时生成的一个md5工具
var crypto = require('crypto');
function md5(text) {
    return crypto.createHash('md5').update(text).digest('hex');
}

/**
 * 登录测试
 * @param username 用户名
 * @param password 经过md5过后的密码
 * @param captcha
 */
var login = function (username, password, captcha) {
    setTimeout(function () {
        skdClient.appTokenRestler.post(userConfig.loginUrl, {
            req: {},
            res: {},
            data: {
                "client_id": oauthConfig.appKey,          // TODO: auth2 还不支持 token 的形式登录  2016-09-08
                "client_secret": oauthConfig.appSecret,   // TODO: auth2 还不支持 token 的形式登录  2016-09-08
                "user_name": username.substr(0, 50),
                "password": password.substr(0, 50),
                "captcha": (captcha || "").substr(0, 6) || null
            }
        }).on("success", function (data) {
            console.info("fetchUser success: %j", data.user.nick_name);
            //console.log(data.user.user_client[0]);
            fetchUserAppConfig(new AccessToken(data.token.access_token, data.token.expires_in, data.token.refresh_token));
        }).on("error", function (result, response) {
            console.error("fetchUser error:", result);
        }).on("fail", function (result) {
            console.error("fetchUser fail:", result);
        });
    }, 1000);
};

var fetchUserAppConfig = function (token) {
    console.log("token: ", token);
    //userConfig.userAppConfigUrl = "http://172.19.100.143:9964/biz-heartbeat";
    skdClient.userTokenRestler.get(userConfig.userAppConfigUrl, {
        req: {
            session: {
                "_USER_TOKEN_": token
            }
        },
        res: {}
    }).on("success", function (data) {
        console.info("fetchUserAppConfig success: ", data);
    }).on("error", function (result, response) {
        console.error("fetchUserAppConfig error:", result);
    }).on("fail", function (result) {
        console.error("fetchUserAppConfig fail:", result);
    });

};

/**
 * 加载主题列表
 */
var loadTopicsTest = function () {
    skdClient.tokenRestler.get("http://test.antfact.com/eagleyes/v2/event/select_event_by_status", {
        query: {status: JSON.stringify(["SHOW", "HIDE"])}
    }, {
        "_USER_TOKEN_": {
//            access_token: "2zq5Ca2Q44Hbbof0CrhkMDsb",
//            refresh_token: "3wb8mFaHF4l99uR0HplehPyY"
//            access_token: "23LmMb9j64SlbOr189A38n1p",
//            refresh_token: "2dnN18aYU4uF9aB06grxPxgN"
            access_token: "0YoSkm66s4TL9V40b52ZnLJh",
            refresh_token: "0urc0r65l4r39pX0UrA0oZ5j"
        }
    }).on("error", function (errorObj, response) {
        console.error("error:", errorObj);
    }).on("fail", function (errorObj, response) {
        console.error("fail:", errorObj);
    }).on("success", function (data) {
        console.info("success:", data);
    });
};

//fetchUserDetailTest("qinlu", md5("q6512996"));
login("wuyaoqian", md5("wuyaoqian@1"));
//fetchUserDetailTest("wuyaoqian", md5("123456"));
//fetchUserDetailTest("wuyaoqian_test", md5("wuyaoqian_test1"));
//fetchUserDetailTest("tangwei", md5("123456"));
//loadTopicsTest();

// console.log(md5("wuyaoqian@123"));