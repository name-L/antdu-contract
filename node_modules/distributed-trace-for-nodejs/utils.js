var Int64 = require("node-int64");
var Int64Transform = require("int64");
var os = require('os');
var parseURL = require("url").parse;

//产生一个int64的十进制表示数
function randomInt64() {
    var random = new Int64(Math.random() * 0x80000000, Math.random() * 0x100000000);
    return Int64Transform.hex2dec(random.toOctetString());
}

var REG = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;

//将一个ip转换为int
function ipToInt(IP) {
    var result = REG.exec(IP);
    if (!result) return "-1";
    return ((parseInt(result[1]) << 24
        | parseInt(result[2]) << 16
        | parseInt(result[3]) << 8
        | parseInt(result[4]))) + '';
}

//获取本机IP
function getIp() {
    var ifaces = os.networkInterfaces();
    var addresses = [];
    Object.keys(ifaces).forEach(function (ifname) {
        ifaces[ifname].forEach(function (iface) {
            if ('IPv4' !== iface.family || iface.internal !== false) {
                return;
            }
            addresses.push(iface.address);
        });
    });
    return addresses[0];
}

//获取请求路径
function getPathname(str) {
    var info = parseURL(str);
    return info.pathname;
}

/**
 * 获取客户端ip
 * @param req
 */
function getCustomerIp(req) {
    if (!req || !req.headers || !req.connection || !req.socket) {
        return '0.0.0.0';
    }
    var ip = req.headers['x-real-ip'] || req.header('x-forwarded-for');
    if (ip) {
        var forwardedIps = ip.split(',');
        ip = forwardedIps[0];
    }
    if (!ip) {
        ip = req.connection.remoteAddress ||
            req.socket.remoteAddress ||
            (req.connection.socket ? (req.connection.socket.remoteAddress ? req.connection.socket.remoteAddress : '0.0.0.0') : '0.0.0.0');
        var remoteIps = ip.split(':');
        ip = remoteIps[remoteIps.length - 1] ? remoteIps[remoteIps.length - 1] : ip;
    }
    return ip;
}

exports.randomInt64 = randomInt64;
exports.ipToInt = ipToInt;
exports.getIp = getIp;
exports.getPathname = getPathname;
exports.getCustomerIp = getCustomerIp;