# log4js-restlet
log4j使用rest请求提交日志组件

## package.json 中添加依赖
```
 "dependencies": {
    "log4js-restlet": "git+ssh://git@git.eefung.com:modules-nodejs/log4js-restlet.git#v1.0.1",
    "axios": "^0.18.0"
 }
```
 * <b>注意务必在dependencies中添加axios依赖！！！</b>

## log4js-restlet 配置示例：
```
{
    'type': 'logLevelFilter',
    'level': 'INFO',
    'appender': {
         'type': 'log4js-restlet',
         'url': 'http://log-collector.antducloud.com',
         'indexName': global.log_setting_es_index_name,
         'tags': global.log_setting_es_layout_tags,
         'buffersize': 512,
         'timeout': 30000
    }
}
```
[查看完整例子](/example/app-logging-dev.js)

## 监听全局异常
```
process.on('uncaughtException', function (err) {
    logger.error('UnCaughted exception: \n', err.stack ? err.stack : err);
    require('log4js-restlet').flushAll(true, function () {
        // 这里的逻辑处理仅常规写法，可依据各自项目的需要进行修改。
        if ((process.env.uncaughtExceptionExit === undefined && config.uncaughtExceptionExit) ||
            process.env.uncaughtExceptionExit === 1) {
            process.exit(0);
        }
    });
});
```

## log4js-restlet 全部配置：
```
{
    'type': 'logLevelFilter',
    'level': 'INFO',
    'appender': {
         'type': 'log4js-restlet',
         'url': 'http://log-collector.antducloud.com', // 提交日志rest地址
         'method': 'post', // 提交日志方式，默认'post'
         'maxContentLength': Infinity , // 提交日志body大小限制，默认无限制   
         'headers': {}, // 提交日志的头信息 ，默认为 {'Content-Type': 'application/json'}
         'params': {}, // 提交日志query参数，默认为空
         'indexName': 'vue-demo', // es索引名称，会自动创建
         'channel': 'log4js-restlet-nodejs', // 日志发布到到通道，默认'log4js-restlet-nodejs#<当前运行路径>'
         'tags': ['account-set-micro'], // 标签，默认为空
         'buffersize': 512, // 缓存大小
         'timeout': 30000, // 提交日志超时时间
         'limitSubmitPreMilliseconds': 1000, // 限制统计使用时长，单位毫秒，默认1秒
         'limitSubmitPreCount': 150 // 限制时长内最大提交条数，默认150条/秒
    }
}
```

## 本地开发配置hosts
```
10.20.1.72 log-collector.antducloud.com
10.20.1.72 kibana-log.antducloud.com
```

## kibana 日志界面
* 查询vue-demo索引：http://kibana-log.antducloud.com/app/kibana#/discover?_g=()&_a=(columns:!(levelStr,message,tags),filters:!(),index:e388fd70-68d5-11ea-a51e-35872feee27b,interval:auto,query:(language:lucene,query:''),sort:!(datatime,desc))
* 注意首次查询的索引，需要进入 http://kibana-log.antducloud.com/app/kibana#/management/kibana/index?_g=() 创建 index pattern。
```
创建 index pattern 步骤：
1. 非常关键：必须先使用日志组件，至少写入一条日志数据，才会自动生成相应到es索引indexName，否则无法进行下一步！！！切记！！！
2. Step 1 of 2: Define index pattern 中，Index pattern输入框输入索引名称，如：app* ，如果没搜索到索引，无法下一步，请检测步骤1和日志组件中配置indexName是否正确。
3. 点击按钮 "Next step"，进入 Step 2 of 2: Configure settings 中，下拉选择 "datatime"（务必选择datatime，如果看不到datatime下拉选项就多写一些日志进去），最后点击按钮"Create index pattern" 完成。
```
