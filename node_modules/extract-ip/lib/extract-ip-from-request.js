/*!
 * Copyright (c) 2010-2021 EEFUNG Software Co.Ltd. All rights reserved.
 * 版权所有 (c) 2010-2021 湖南蚁坊软件股份有限公司。保留所有权利。
 */

'use strict';

/**
 * 公用的一些工具类方法 (客户端ip的获取方法)
 * Created by wuyaoqian on 14-4-17.
 */

module.exports = {
    /**
     * 从 request 对象中获取 客户端IP
     * @param {IncomingMessage} req
     * @returns {string} ip地址
     */
    getClientIp: function (req) {
        if (!req || !req.headers || !req.connection || !req.socket) {
            return '0.0.0.0';
        }
        const ip = req.headers['x-real-ip'] || //
            req.headers['x-forwarded-for'] || //
            req.connection.remoteAddress || //
            req.socket.remoteAddress || //
            (req.connection.socket
                ? (req.connection.socket.remoteAddress
                    ? req.connection.socket.remoteAddress
                    : '0.0.0.0')
                : '0.0.0.0');

        return ip === '::1' ? 'localhost' : ip.replace(/(::ffff:)(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/i, '$2');
    }
};
